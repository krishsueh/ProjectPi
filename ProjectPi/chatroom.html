<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>SL</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

    <!--Reference the SignalR library. -->
    <script src="https://pi.rocket-coding.com/Scripts/jquery.signalR-2.4.3.min.js"></script>
    <!--Reference the autoGenerated SignalR hub script. -->
    <script src="https://pi.rocket-coding.com/signalr/hubs"></script>

    <script type="text/javascript">
        $(function () {
            //存檔使用者的GUID，判斷是User 或 Counselor 這邊預設是User傳給Counselor
            const userGuid = "a-a-a-a";
            //儲存當前用戶名
            $('#userName').val(prompt('请输入您的名称', ''));

            //连接后端hub
            $.connection.hub.url = 'https://pi.rocket-coding.com/signalr';
            chat = $.connection.chartHubb;
            console.info(chat);

            //注册后台
            chat.client.broadcastUserList = function (data) {
                if (data) {
                    var json = $.parseJSON(data);
                    console.info(json);

                    $('#user-list-group').html('');
                    for (var i = 0; i < json.length; i++) {

                        var mhtml = '<button type="button" class="list-group-item" title="' + json[i].ConnectionID + '" onclick="listGroupItemClick(this);" >' + json[i].UserName + '</button>';

                        $('#user-list-group').append(mhtml);
                    }
                }
            }  //end broadcastUserList

            //注册后台
            chat.client.showMessage = function (speakerName, message) {
                var msg = '';

                if (speakerName == $('#curUserName').text()) {
                    msg = '<p><span class="label label-success"> ' + speakerName + '</span>' + message + '</p>';
                }
                else {
                    msg = '<p><span class="label label-info"> ' + speakerName + '</span>' + message + '</p>';
                }

                $('#contextDIV').append(msg);
                $('#message').val('');
                $('#message').val('').focus();
            }   //end showMessage

            //发送按钮
            $('#sendmessage').click(function () {
                var outid = $('#sid').text();
                var outmessage = $('#message').val();

                if (outid != '' && outmessage != '') {
                    //傳入訊息 && API存內容

                    chat.server.sendTo(outid, outmessage);
                }
                else {
                    alert('请选择接收消息的用户（或者没有输入任何内容）');
                }

            });  //end click


            //连接成功后获取自己的信息
            $.connection.hub.start().done(function () {
                $('#curUserName').text($('#userName').val());
                chat.server.setUserName($('#userName').val());
            });

        });   //end page ready


        //左侧名字列表 点击事件
        function listGroupItemClick(that) {
            var tname = $(that).text();
            var tid = $(that).attr('title');

            $('#sname').text(tname);
            $('#sid').text(tid);
        }//end listGroupItemClick


        //回车键
        $(document).keydown(function () {
            if (event.keyCode == 13) {
                $('#sendmessage').click();
            }
        });  //end keydown



    </script>

</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-12 col-sm-12">
                <div class="well well-sm">
                    <div class="text-center">
                        当前用户：
                        <span id="curUserName"></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-2 col-sm-4">
                <div id="user-list-group" class="list-group">

                </div>
                <!--hiden value-->
                <div style="display:none;">
                    <input type="text" id="userName" name="userName" />
                </div>
            </div>  <!--end left-->

            <div class="col-md-10 col-sm-8">
                <div class="row">
                    <!--CHART text-->
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            对话框：
                            <span id="sname"></span>
                            【<span id="sid"></span>】
                        </div>

                        <div class="panel-body">
                            <div id="contextDIV" style="height:500px;overflow:auto;">

                            </div>
                        </div> <!--end panel body-->

                        <div class="panel-footer">
                            <div class="row">
                                <div class="col-md-12 col-sm-12">
                                    <div class="input-group">
                                        <input type="text" id="message" name="message" class="form-control" />
                                        <span class="input-group-btn">
                                            <input type="button" class="btn btn-default" id="sendmessage" name="sendmessage" value="发送" />
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div><!--end pannel foot-->

                    </div> <!--end pannel-->
                </div>
            </div>  <!--end right-->
        </div>

    </div>
</body>
</html>